generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Role {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String   @unique
  permissions Json     @default("[]")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  active      Boolean  @default(true)
  isSystem    Boolean  @default(false)
  sortOrder   Int      @default(100)
  users       User[]
}

// Multi-tenant: Alıcı Firma (Tenant)
model Tenant {
  id            String    @id @default(cuid())
  name          String    @unique
  slug          String    @unique
  taxId         String?   @unique
  email         String
  phone         String?
  address       String?   @db.VarChar(500)
  logo          String?
  
  // Abonelik bilgileri
  plan          String    @default("free")  // free, pro, enterprise
  planExpiresAt DateTime?
  isActive      Boolean   @default(true)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // İlişkiler
  users         User[]
  requests      Request[]
  orders        Order[]
  rfqs          Rfq[]
  contracts     Contract[]
  invoices      Invoice[]
  deliveries    DeliveryReceipt[]
  supplierLinks TenantSupplier[]
  
  @@index([slug])
  @@index([isActive])
}

// Tenant-Supplier İlişkisi (Onay durumu ile)
model TenantSupplier {
  id           String    @id @default(cuid())
  tenantId     String
  supplierId   String
  status       String    @default("pending")  // pending, approved, rejected, blocked
  approvedAt   DateTime?
  approvedById String?
  notes        String?   @db.VarChar(500)
  createdAt    DateTime  @default(now())
  
  tenant       Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  supplier     Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  approvedBy   User?     @relation("TenantSupplierApprover", fields: [approvedById], references: [id])
  
  @@unique([tenantId, supplierId])
  @@index([tenantId])
  @@index([supplierId])
  @@index([status])
}

model User {
  id                  String                  @id @default(cuid())
  username            String                  @unique
  passwordHash        String
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  email               String?                 @unique
  role                String                  @default("user")
  roleId              String?
  unitId              String?
  isActive            Boolean                 @default(true)
  supplierId          String?
  lastLoginAt         DateTime?
  phoneNumber         String?
  
  // Multi-tenant alanları
  tenantId            String?
  isSuperAdmin        Boolean                 @default(false)
  
  approvalRecords     ApprovalRecord[]        @relation("ApprovalRecordApprover")
  auditLogs           AuditLog[]
  comments            Comment[]               @relation("UserComments")
  Contract            Contract[]
  deliveriesReceived  DeliveryReceipt[]
  Invoice             Invoice[]
  notifications       Notification[]
  notificationPref    NotificationPreference?
  Order               Order[]
  requestsOwned       Request[]               @relation("RequestOwner")
  requestsResponsible Request[]               @relation("RequestResponsible")
  createdRfqs         Rfq[]
  roleRef             Role?                   @relation(fields: [roleId], references: [id])
  supplier            Supplier?               @relation(fields: [supplierId], references: [id])
  unit                OptionItem?             @relation("UserUnit", fields: [unitId], references: [id])
  approvedSuppliers   Supplier[]              @relation("ApprovedSuppliers")
  rfqMessages         RfqMessage[]
  tenant              Tenant?                 @relation(fields: [tenantId], references: [id])
  tenantSupplierApprovals TenantSupplier[]    @relation("TenantSupplierApprover")
  
  @@index([tenantId])
  @@index([isSuperAdmin])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String?
  oldData    Json?
  newData    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model OptionCategory {
  id    String       @id @default(cuid())
  key   String       @unique
  name  String
  items OptionItem[]
}

model OptionItem {
  id                       String            @id @default(cuid())
  label                    String
  active                   Boolean           @default(true)
  sort                     Int               @default(1)
  categoryId               String
  email                    String?
  deliveriesReceivedAsUnit DeliveryReceipt[] @relation("UnitDeliveries")
  category                 OptionCategory    @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  ordersAsCurrency         Order[]           @relation("OrderCurrency")
  ordersAsMethod           Order[]           @relation("OrderMethod")
  ordersAsRegulation       Order[]           @relation("OrderRegulation")
  ordersAsStatus           Order[]           @relation("OrderStatus")
  orderItemsAsUnit         OrderItem[]
  requestsAsCurrency       Request[]         @relation("RequestCurrency")
  requestsAsRelatedPerson  Request[]         @relation("RequestRelatedPerson")
  requestsAsStatus         Request[]         @relation("RequestStatus")
  requestsAsUnit           Request[]         @relation("RequestUnit")
  requestItemsAsUnit       RequestItem[]     @relation("RequestItemUnit")
  usersAsUnit              User[]            @relation("UserUnit")
}

model Supplier {
  id                  String                      @id @default(cuid())
  name                String                      @unique
  active              Boolean                     @default(true)
  address             String?                     @db.VarChar(500)
  contactName         String?
  createdAt           DateTime                    @default(now())
  email               String?                     @unique
  notes               String?
  phone               String?
  taxId               String?                     @unique
  taxOffice           String?
  bankName            String?
  bankBranch          String?
  bankIban            String?
  bankAccountNo       String?
  bankCurrency        String?                     @default("TRY")
  commercialRegistrationNo String?
  mersisNo            String?
  updatedAt           DateTime                    @updatedAt
  website             String?
  categoryId          String?                     // Primary category (backward compat)
  
  // Registration approval fields
  registrationStatus  String                      @default("approved") // pending, approved, rejected
  registrationSource  String?                     // self, invite, admin
  approvedAt          DateTime?
  approvedById        String?
  approvedBy          User?                       @relation("ApprovedSuppliers", fields: [approvedById], references: [id])
  
  // Platform seviyesi onay (multi-tenant)
  platformApproved    Boolean                     @default(false)
  platformApprovedAt  DateTime?
  
  orders              Order[]
  productsPreferred   Product[]                   @relation("PreferredSupplier")
  rfqParticipations   RfqSupplier[]
  category            SupplierCategory?           @relation(fields: [categoryId], references: [id])
  categories          SupplierCategoryMapping[]   // Multiple categories support
  alerts              SupplierAlert[]             @relation("SupplierAlerts")
  evaluations         SupplierEvaluation[]
  evaluationSummaries SupplierEvaluationSummary[] @relation("SupplierEvaluationSummaries")
  performanceMetrics  SupplierPerformanceMetric[] @relation("SupplierPerformanceMetrics")
  supportTickets      SupportTicket[]
  users               User[]
  tenantLinks         TenantSupplier[]

  @@index([active])
  @@index([registrationStatus])
  @@index([platformApproved])
}

// Many-to-many mapping for Supplier <-> Category
model SupplierCategoryMapping {
  id          String           @id @default(cuid())
  supplierId  String
  categoryId  String
  createdAt   DateTime         @default(now())
  supplier    Supplier         @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  category    SupplierCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([supplierId, categoryId])
  @@index([supplierId])
  @@index([categoryId])
}

model SupplierCategory {
  id               String                    @id @default(cuid())
  name             String
  parentId         String?
  createdAt        DateTime                  @default(now())
  updatedAt        DateTime                  @updatedAt
  rfqItems         RfqItem[]
  suppliers        Supplier[]
  supplierMappings SupplierCategoryMapping[]
  parent           SupplierCategory?         @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children         SupplierCategory[]        @relation("CategoryHierarchy")
}

model Company {
  id        String  @id @default(cuid())
  name      String  @unique
  active    Boolean @default(true)
  address   String? @db.VarChar(500)
  taxId     String? @unique
  email     String? @db.VarChar(200)
  phone     String? @db.VarChar(50)
  taxOffice String? @db.VarChar(200)
  orders    Order[]
  rfqs      Rfq[]
}

model DeliveryAddress {
  id            String   @id @default(cuid())
  name          String
  address       String   @db.VarChar(500)
  city          String?
  district      String?
  postalCode    String?
  phone         String?
  contactPerson String?
  active        Boolean  @default(true)
  isDefault     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  orders        Order[]
  rfqs          Rfq[]
}

model Request {
  id                String        @id @default(cuid())
  barcode           String        @unique
  createdAt         DateTime      @default(now())
  subject           String        @db.VarChar(500)
  budget            Decimal       @db.Decimal(18, 2)
  relatedPersonId   String
  unitId            String
  statusId          String
  currencyId        String
  ownerUserId       String?
  responsibleUserId String?
  unitEmail         String?
  justification     String?       @db.VarChar(2000)
  rfqId             String?
  tenantId          String?
  attachments       Attachment[]
  comments          Comment[]
  orders            Order[]
  currency          OptionItem    @relation("RequestCurrency", fields: [currencyId], references: [id])
  owner             User?         @relation("RequestOwner", fields: [ownerUserId], references: [id])
  relatedPerson     OptionItem    @relation("RequestRelatedPerson", fields: [relatedPersonId], references: [id])
  responsible       User?         @relation("RequestResponsible", fields: [responsibleUserId], references: [id])
  rfq               Rfq?          @relation(fields: [rfqId], references: [id])
  status            OptionItem    @relation("RequestStatus", fields: [statusId], references: [id])
  unit              OptionItem    @relation("RequestUnit", fields: [unitId], references: [id])
  items             RequestItem[]
  tenant            Tenant?       @relation(fields: [tenantId], references: [id])
  
  @@index([tenantId])
}

model Attachment {
  id         String           @id @default(cuid())
  requestId  String?
  fileName   String
  url        String
  type       String?
  createdAt  DateTime         @default(now())
  deliveryId String?
  delivery   DeliveryReceipt? @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
  request    Request?         @relation(fields: [requestId], references: [id], onDelete: Cascade)
}

model Comment {
  id        String   @id @default(cuid())
  requestId String
  text      String
  authorId  String
  createdAt DateTime @default(now())
  author    User     @relation("UserComments", fields: [authorId], references: [id])
  request   Request  @relation(fields: [requestId], references: [id], onDelete: Cascade)
}

model RequestItem {
  id        String     @id @default(cuid())
  requestId String
  name      String
  quantity  Decimal    @db.Decimal(18, 2)
  unitId    String
  unitPrice Decimal    @default(0) @db.Decimal(18, 2)
  productId String?
  sku       String?
  product   Product?   @relation(fields: [productId], references: [id])
  request   Request    @relation(fields: [requestId], references: [id], onDelete: Cascade)
  unit      OptionItem @relation("RequestItemUnit", fields: [unitId], references: [id])
}

model Order {
  id                String               @id @default(cuid())
  barcode           String               @unique
  createdAt         DateTime             @default(now())
  requestId         String?
  statusId          String
  methodId          String
  regulationId      String
  currencyId        String
  supplierId        String
  companyId         String
  realizedTotal     Decimal              @db.Decimal(18, 2)
  responsibleUserId String?
  estimatedDelivery DateTime?
  deliveryAddressId String?
  refNumber         String?
  tenantId          String?
  contracts         Contract[]
  deliveries        DeliveryReceipt[]
  deliveryTokens    DeliveryToken[]
  invoices          Invoice[]
  company           Company              @relation(fields: [companyId], references: [id])
  currency          OptionItem           @relation("OrderCurrency", fields: [currencyId], references: [id])
  deliveryAddress   DeliveryAddress?     @relation(fields: [deliveryAddressId], references: [id])
  method            OptionItem           @relation("OrderMethod", fields: [methodId], references: [id])
  regulation        OptionItem           @relation("OrderRegulation", fields: [regulationId], references: [id])
  request           Request?             @relation(fields: [requestId], references: [id])
  responsible       User?                @relation(fields: [responsibleUserId], references: [id])
  status            OptionItem           @relation("OrderStatus", fields: [statusId], references: [id])
  supplier          Supplier             @relation(fields: [supplierId], references: [id])
  items             OrderItem[]
  evaluations       SupplierEvaluation[]
  tenant            Tenant?              @relation(fields: [tenantId], references: [id])
  
  @@index([tenantId])
}

model DeliveryToken {
  id        String   @id @default(cuid())
  token     String   @unique
  orderId   String
  expiresAt DateTime
  createdAt DateTime @default(now())
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model DeliveryReceipt {
  id             String         @id @default(cuid())
  code           String         @unique
  date           DateTime
  deliveryDate   DateTime       @default(now())
  orderId        String
  receiverId     String?
  receiverName   String?
  receiverUnitId String?
  receiverEmail  String?
  status         String         @default("pending")
  notes          String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  tenantId       String?
  attachments    Attachment[]
  items          DeliveryItem[]
  order          Order          @relation(fields: [orderId], references: [id])
  receiver       User?          @relation(fields: [receiverId], references: [id])
  receiverUnit   OptionItem?    @relation("UnitDeliveries", fields: [receiverUnitId], references: [id])
  tenant         Tenant?        @relation(fields: [tenantId], references: [id])
  
  @@index([tenantId])
}

model DeliveryItem {
  id               String          @id @default(cuid())
  deliveryId       String
  orderItemId      String
  quantity         Decimal         @db.Decimal(18, 2)
  approvedQuantity Decimal?        @db.Decimal(18, 2)
  notes            String?
  delivery         DeliveryReceipt @relation(fields: [deliveryId], references: [id], onDelete: Cascade)
  orderItem        OrderItem       @relation(fields: [orderItemId], references: [id])
}

model OrderItem {
  id         String         @id @default(cuid())
  orderId    String
  name       String
  quantity   Decimal        @db.Decimal(18, 2)
  unitPrice  Decimal        @default(0) @db.Decimal(18, 2)
  extraCosts Decimal?       @default(0) @db.Decimal(18, 2)
  sku        String?
  unitId     String?
  deliveries DeliveryItem[]
  order      Order          @relation(fields: [orderId], references: [id], onDelete: Cascade)
  unit       OptionItem?    @relation(fields: [unitId], references: [id])
}

model Contract {
  id                String               @id @default(cuid())
  number            String               @unique
  title             String
  parties           String               @db.VarChar(500)
  startDate         DateTime
  endDate           DateTime?
  status            String               @db.VarChar(50)
  version           Int                  @default(1)
  createdAt         DateTime             @default(now())
  orderId           String?
  deletedAt         DateTime?
  updatedAt         DateTime             @updatedAt
  template          String?              @db.VarChar(50)
  type              String?              @db.VarChar(50)
  responsibleUserId String?
  tenantId          String?
  order             Order?               @relation(fields: [orderId], references: [id])
  responsible       User?                @relation(fields: [responsibleUserId], references: [id])
  attachments       ContractAttachment[]
  events            ContractEvent[]
  histories         ContractHistory[]
  revisions         ContractRevision[]
  tenant            Tenant?              @relation(fields: [tenantId], references: [id])
  
  @@index([tenantId])
}

model ContractHistory {
  id         String   @id @default(cuid())
  contractId String
  date       DateTime @default(now())
  fromStatus String   @db.VarChar(50)
  toStatus   String   @db.VarChar(50)
  version    Int
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

model ContractAttachment {
  id         String   @id @default(cuid())
  contractId String
  title      String   @db.VarChar(200)
  url        String   @db.VarChar(500)
  mimeType   String   @db.VarChar(100)
  uploadedAt DateTime @default(now())
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

model ContractRevision {
  id               String    @id @default(cuid())
  contractId       String
  createdAt        DateTime  @default(now())
  createdByUserId  String?
  pending          Boolean   @default(true)
  approvedAt       DateTime?
  approvedByUserId String?
  changes          Json
  contract         Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

model ContractEvent {
  id         String   @id @default(cuid())
  contractId String
  type       String   @db.VarChar(50)
  date       DateTime
  note       String?  @db.VarChar(500)
  createdAt  DateTime @default(now())
  contract   Contract @relation(fields: [contractId], references: [id], onDelete: Cascade)
}

model Invoice {
  id                String        @id @default(cuid())
  number            String        @unique
  orderNo           String        @db.VarChar(100)
  amount            Decimal       @db.Decimal(18, 2)
  dueDate           DateTime
  status            String        @db.VarChar(50)
  bank              String?       @db.VarChar(100)
  createdAt         DateTime      @default(now())
  orderId           String?
  vatRate           Int?
  withholdingCode   String?
  responsibleUserId String?
  tenantId          String?
  order             Order?        @relation(fields: [orderId], references: [id])
  responsible       User?         @relation(fields: [responsibleUserId], references: [id])
  items             InvoiceItem[]
  tenant            Tenant?       @relation(fields: [tenantId], references: [id])
  
  @@index([tenantId])
}

model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  name      String
  quantity  Decimal @db.Decimal(18, 2)
  unitPrice Decimal @db.Decimal(18, 2)
  taxRate   Int?
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
}

model EvaluationQuestion {
  id            String                     @id @default(cuid())
  text          String
  type          String
  active        Boolean                    @default(true)
  required      Boolean                    @default(false)
  section       String?                    @db.VarChar(10)
  sort          Int                        @default(0)
  scoringTypeId String?
  options       EvaluationOption[]
  scoringType   ScoringType?               @relation(fields: [scoringTypeId], references: [id])
  answers       SupplierEvaluationAnswer[]
}

model EvaluationOption {
  id         String             @id @default(cuid())
  label      String
  questionId String
  question   EvaluationQuestion @relation(fields: [questionId], references: [id])
}

model ScoringType {
  id          String               @id @default(cuid())
  code        String               @unique
  name        String
  kind        String               @db.VarChar(50)
  scaleMin    Int                  @default(1)
  scaleMax    Int                  @default(5)
  step        Int                  @default(1)
  active      Boolean              @default(true)
  createdAt   DateTime             @default(now())
  description String?
  weightA     Float                @default(0.40)
  weightB     Float                @default(0.30)
  weightC     Float                @default(0.30)
  questions   EvaluationQuestion[]
}

model SupplierEvaluation {
  id          String                     @id @default(cuid())
  orderId     String
  supplierId  String
  submittedAt DateTime?
  totalScore  Decimal?                   @db.Decimal(18, 2)
  order       Order                      @relation(fields: [orderId], references: [id])
  supplier    Supplier                   @relation(fields: [supplierId], references: [id])
  answers     SupplierEvaluationAnswer[]
}

model SupplierEvaluationAnswer {
  id           String             @id @default(cuid())
  evaluationId String
  questionId   String
  value        String
  evaluation   SupplierEvaluation @relation(fields: [evaluationId], references: [id])
  question     EvaluationQuestion @relation(fields: [questionId], references: [id])
}

model ReportTemplate {
  id        String   @id @default(cuid())
  name      String   @unique
  config    Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ownerId   String?
}

model SupplierPerformanceMetric {
  id           String   @id @default(cuid())
  supplierId   String
  period       String   @db.VarChar(20)
  source       String   @db.VarChar(50)
  onTimeRate   Float?
  defectRate   Float?
  avgLeadTime  Float?
  priceIndex   Float?
  serviceScore Float?
  createdAt    DateTime @default(now())
  supplier     Supplier @relation("SupplierPerformanceMetrics", fields: [supplierId], references: [id])

  @@unique([supplierId, period, source])
  @@index([supplierId, period])
}

model SupplierEvaluationSummary {
  id            String   @id @default(cuid())
  supplierId    String
  period        String   @db.VarChar(20)
  qualityScore  Float
  deliveryScore Float
  costScore     Float
  serviceScore  Float
  totalScore    Float
  decision      String   @db.VarChar(50)
  createdAt     DateTime @default(now())
  supplier      Supplier @relation("SupplierEvaluationSummaries", fields: [supplierId], references: [id])

  @@unique([supplierId, period])
  @@index([period, totalScore])
}

model SupplierReport {
  id        String   @id @default(cuid())
  period    String   @db.VarChar(20)
  scope     String   @db.VarChar(50)
  payload   Json
  createdAt DateTime @default(now())
}

model SupplierAlert {
  id           String   @id @default(cuid())
  supplierId   String
  period       String   @db.VarChar(20)
  type         String   @db.VarChar(50)
  message      String   @db.VarChar(500)
  severity     String   @db.VarChar(20)
  createdAt    DateTime @default(now())
  acknowledged Boolean  @default(false)
  supplier     Supplier @relation("SupplierAlerts", fields: [supplierId], references: [id])

  @@index([supplierId, period])
}

model LoginAttempt {
  id        String   @id @default(cuid())
  username  String?
  email     String?
  userId    String?
  ip        String?
  userAgent String?
  success   Boolean
  reason    String?  @db.VarChar(200)
  createdAt DateTime @default(now())

  @@index([email])
  @@index([username])
  @@index([userId])
  @@index([createdAt])
  @@index([success])
}

model WithholdingJobType {
  id        String   @id @default(cuid())
  code      String   @unique
  label     String
  ratio     String
  active    Boolean  @default(true)
  sort      Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  title     String
  body      String
  type      String   @db.VarChar(50)
  read      Boolean  @default(false)
  createdAt DateTime @default(now())
  meta      Json?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([createdAt])
}

model NotificationPreference {
  id            String   @id @default(cuid())
  userId        String   @unique
  emailEnabled  Boolean  @default(true)
  inAppEnabled  Boolean  @default(true)
  digestEnabled Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model SmtpSetting {
  id        String   @id @default(cuid())
  host      String
  port      Int
  secure    Boolean  @default(false)
  user      String
  pass      String
  from      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  active    Boolean  @default(true)
  isDefault Boolean  @default(false)
  key       String   @unique
  name      String?
}

model EmailLog {
  id          String    @id @default(cuid())
  to          String
  subject     String
  category    String?   @db.VarChar(50)
  status      String    @db.VarChar(20)
  attempts    Int       @default(0)
  lastError   String?   @db.VarChar(500)
  messageId   String?   @db.VarChar(200)
  previewUrl  String?
  createdAt   DateTime  @default(now())
  sentAt      DateTime?
  payloadHtml String?   @db.VarChar(20000)

  @@index([status, createdAt])
}

model ApprovalWorkflow {
  id          String         @id @default(cuid())
  name        String         @unique
  displayName String         @db.VarChar(100)
  entityType  String         @db.VarChar(50)
  active      Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  steps       ApprovalStep[]
}

model ApprovalStep {
  id           String           @id @default(cuid())
  workflowId   String
  stepOrder    Int
  name         String           @db.VarChar(100)
  description  String?          @db.VarChar(500)
  approverRole String?          @db.VarChar(50)
  approverUnit String?
  required     Boolean          @default(true)
  autoApprove  Boolean          @default(false)
  budgetLimit  Decimal?         @db.Decimal(18, 2)
  createdAt    DateTime         @default(now())
  workflow     ApprovalWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([workflowId, stepOrder])
  @@index([workflowId])
}

model ApprovalRecord {
  id          String    @id @default(cuid())
  entityType  String    @db.VarChar(50)
  entityId    String
  stepOrder   Int
  stepName    String    @db.VarChar(100)
  status      String    @db.VarChar(20)
  approverId  String?
  comment     String?   @db.VarChar(1000)
  createdAt   DateTime  @default(now())
  processedAt DateTime?
  approver    User?     @relation("ApprovalRecordApprover", fields: [approverId], references: [id])

  @@index([entityType, entityId])
  @@index([status])
  @@index([approverId])
}

model Rfq {
  id                String           @id @default(cuid())
  rfxCode           String           @unique
  title             String
  status            String           @default("ACTIVE")
  deadline          DateTime?
  createdById       String
  companyId         String?
  deliveryAddressId String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  tenantId          String?
  requests          Request[]
  company           Company?         @relation(fields: [companyId], references: [id])
  createdBy         User             @relation(fields: [createdById], references: [id])
  deliveryAddress   DeliveryAddress? @relation(fields: [deliveryAddressId], references: [id])
  items             RfqItem[]
  suppliers         RfqSupplier[]
  messages          RfqMessage[]
  tenant            Tenant?          @relation(fields: [tenantId], references: [id])
  
  @@index([tenantId])
}

model RfqItem {
  id            String            @id @default(cuid())
  rfqId         String
  name          String
  quantity      Decimal           @db.Decimal(18, 2)
  unit          String
  description   String?
  requestItemId String?
  categoryId    String?
  offers        OfferItem[]
  category      SupplierCategory? @relation(fields: [categoryId], references: [id])
  rfq           Rfq               @relation(fields: [rfqId], references: [id], onDelete: Cascade)
}

model RfqSupplier {
  id          String    @id @default(cuid())
  rfqId       String
  supplierId  String?
  contactName String?
  companyName String?
  email       String
  token       String    @unique
  tokenExpiry DateTime
  stage       String    @default("PENDING")
  createdAt   DateTime  @default(now())
  offer       Offer?
  rfq         Rfq       @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  supplier    Supplier? @relation(fields: [supplierId], references: [id])

  rfqMessages RfqMessage[]

  @@unique([rfqId, email])
}

model Offer {
  id            String      @id @default(cuid())
  rfqSupplierId String      @unique
  totalAmount   Decimal     @db.Decimal(18, 2)
  currency      String      @default("TRY")
  validUntil    DateTime?
  notes         String?
  attachments   String?
  submittedAt   DateTime    @default(now())
  isWinner      Boolean     @default(false)
  
  // Advanced Fields
  incoterm      String?     // EXW, DDP, DAP etc.
  paymentTerm   String?     // Cash, 30 Days, 60 Days etc.
  extraCostPackaging Decimal? @default(0) @db.Decimal(18, 2)
  extraCostLogistics Decimal? @default(0) @db.Decimal(18, 2)
  
  // New Detailed Fields
  shippingIncluded  Boolean?   @default(false)  // Nakliye dahil mi?
  deliveryDays      Int?                         // Teslimat süresi (iş günü)
  partialDelivery   Boolean?   @default(false)  // Kısmi teslimat yapılabilir mi?
  validityDays      Int?       @default(30)     // Teklif geçerlilik süresi (gün)
  generalWarranty   String?                      // Genel garanti bilgisi
  
  rfqSupplier   RfqSupplier @relation(fields: [rfqSupplierId], references: [id])
  items         OfferItem[]
}

model OfferItem {
  id           String    @id @default(cuid())
  offerId      String
  rfqItemId    String
  quantity     Decimal   @db.Decimal(18, 2)
  unitPrice    Decimal   @db.Decimal(18, 2)
  vatRate      Int       @default(20)
  totalPrice   Decimal   @db.Decimal(18, 2)
  deliveryDate DateTime?
  brand        String?
  notes        String?
  
  // Advanced Fields
  technicalSpecs String?
  isAlternative  Boolean   @default(false)
  warranty       String?   // Warranty info for this item
  
  offer        Offer     @relation(fields: [offerId], references: [id], onDelete: Cascade)
  rfqItem      RfqItem   @relation(fields: [rfqItemId], references: [id])
}

model RfqMessage {
  id              String      @id @default(cuid())
  rfqId           String
  authorId        String?     // User.id (optional if from guest supplier)
  rfqSupplierId   String?     // Link to rfqSupplier (optional if from internal user)
  content         String      @db.Text
  isFromSupplier  Boolean     @default(false)
  createdAt       DateTime    @default(now())
  
  rfq             Rfq         @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  author          User?       @relation(fields: [authorId], references: [id])
  rfqSupplier     RfqSupplier? @relation(fields: [rfqSupplierId], references: [id])
}

model ProductCategory {
  id          String            @id @default(cuid())
  name        String
  code        String            @unique
  description String?
  parentId    String?
  active      Boolean           @default(true)
  sortOrder   Int               @default(0)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  products    Product[]
  parent      ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    ProductCategory[] @relation("CategoryHierarchy")

  @@index([parentId])
  @@index([active])
}

model Product {
  id                  String           @id @default(cuid())
  sku                 String           @unique
  name                String
  description         String?
  categoryId          String?
  defaultUnit         String?
  estimatedPrice      Decimal?         @db.Decimal(18, 2)
  currency            String           @default("TRY")
  preferredSupplierId String?
  minStock            Decimal?         @db.Decimal(18, 2)
  leadTimeDays        Int?
  active              Boolean          @default(true)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  category            ProductCategory? @relation(fields: [categoryId], references: [id])
  preferredSupplier   Supplier?        @relation("PreferredSupplier", fields: [preferredSupplierId], references: [id])
  requestItems        RequestItem[]

  @@index([categoryId])
  @@index([sku])
  @@index([name])
  @@index([active])
  @@index([createdAt])
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  type      String   @default("boolean")
  label     String?
  group     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
  @@index([group])
}

model ModuleAccess {
  id        String   @id @default(cuid())
  moduleKey String
  roleKey   String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([moduleKey, roleKey])
  @@index([moduleKey])
  @@index([roleKey])
}

model SupportTicket {
  id         String   @id @default(cuid())
  supplierId String
  subject    String   @db.VarChar(200)
  message    String   @db.VarChar(2000)
  status     String   @default("OPEN") @db.VarChar(20) // OPEN, IN_PROGRESS, RESOLVED
  priority   String   @default("NORMAL") @db.VarChar(20) // LOW, NORMAL, HIGH
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  supplier   Supplier @relation(fields: [supplierId], references: [id])

  @@index([supplierId])
  @@index([status])
  @@index([createdAt])
}

// Platform genel ayarları (key-value formatında)
model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.Text
  type      String   @default("string") // string, number, boolean, json
  category  String   @default("general") // general, email, security, display
  label     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([category])
}
